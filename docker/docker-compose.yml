# Work Suite Container Stack
# Storage: /zfs/data/work_suite (ZFS on seed)
# Ports: 8500-8501

services:
  # ===========================================
  # Work Suite Web App (Static Frontend)
  # ===========================================
  worksuite-web:
    image: nginx:alpine
    container_name: worksuite-web
    restart: unless-stopped
    ports:
      - "8500:80"
    volumes:
      - ../:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - worksuite-net
    depends_on:
      - worksuite-api
    labels:
      - "com.worksuite.service=web"

  # ===========================================
  # Work Suite API (SQLite + Filesystem)
  # ===========================================
  worksuite-api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: worksuite-api
    restart: unless-stopped
    ports:
      - "8501:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATA_PATH=/data
      - JWT_SECRET=${JWT_SECRET:-change-me-in-production}
      - AI_PROVIDER=${AI_PROVIDER:-none}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Authentik OAuth2 Configuration
      - AUTHENTIK_URL=${AUTHENTIK_URL:-http://192.168.0.110:9500}
      - AUTHENTIK_CLIENT_ID=${AUTHENTIK_CLIENT_ID:-work-suite}
      - AUTHENTIK_CLIENT_SECRET=${AUTHENTIK_CLIENT_SECRET:-fe3f8fb2a9ea4bcc5c59a16e63fd655a5d2398c846b7efab}
      - AUTHENTIK_CALLBACK_URL=${AUTHENTIK_CALLBACK_URL:-http://192.168.0.110:8500/api/auth/callback}
      - FRONTEND_URL=${FRONTEND_URL:-http://192.168.0.110:8500}
      # Service-0 Core Platform Integration
      - SERVICE_0_URL=${SERVICE_0_URL:-http://192.168.0.110:8001}
      - SECURE_COOKIES=${SECURE_COOKIES:-false}
    volumes:
      - /zfs/data/work_suite:/data
    networks:
      - worksuite-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.worksuite.service=api"

networks:
  worksuite-net:
    name: worksuite-net
    driver: bridge

# ===========================================
# Port Summary:
#   8500 - Web UI (nginx)
#   8501 - API (node + SQLite)
#
# Storage on ZFS:
#   /tank/data/work_suite/
#   ├── worksuite.db     (SQLite database)
#   ├── files/           (User files)
#   │   ├── me/          (Private)
#   │   ├── us/          (Shared)
#   │   ├── we/          (Team)
#   │   └── there/       (External)
#   └── backups/         (Auto backups)
# ===========================================
