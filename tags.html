<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tags - Work Suite File Manager</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #09090b;
            --surface: #18181b;
            --surface-hover: #27272a;
            --border: #3f3f46;
            --text: #fafafa;
            --text-muted: #a1a1aa;
            --text-dim: #71717a;
            
            --accent: #6366f1;
            --accent-hover: #818cf8;
            
            --scope-me: #f472b6;
            --scope-us: #a78bfa;
            --scope-we: #38bdf8;
            --scope-there: #4ade80;
            
            --status-backlog: #71717a;
            --status-progress: #f59e0b;
            --status-done: #22c55e;
            --status-closed: #6366f1;
            
            --app-pointer: #ec4899;
            --app-slate: #6366f1;
            --app-done: #3b82f6;
            --app-journey: #f59e0b;
            --app-merman: #06b6d4;
            --app-metric: #10b981;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }
        
        /* Custom Scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-dim);
        }
        
        ::-webkit-scrollbar-corner {
            background: transparent;
        }
        
        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }
        
        /* Layout */
        .app {
            display: grid;
            grid-template-columns: 240px 1fr 300px;
            grid-template-rows: 56px 1fr;
            height: 100vh;
        }
        
        .app.details-hidden {
            grid-template-columns: 240px 1fr;
        }
        
        .app.details-hidden .details-panel {
            display: none;
        }
        
        /* Header */
        header {
            grid-column: 1 / -1;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 16px;
        }
        
        .home-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
            text-decoration: none;
            font-size: 18px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }
        
        .home-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 20px;
        }
        
        .logo-icon {
            font-size: 24px;
        }
        
        .search-box {
            flex: 1;
            max-width: 400px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }
        
        .btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--surface-hover);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: var(--border);
        }
        
        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
        }
        
        /* Sidebar */
        .sidebar {
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 16px;
            overflow-y: auto;
        }
        
        .sidebar-section {
            margin-bottom: 24px;
        }
        
        .sidebar-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            margin-bottom: 8px;
            padding: 0 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-small {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 12px;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        
        .btn-small:hover {
            opacity: 1;
        }
        
        .workspace-select {
            width: 100%;
            padding: 8px 10px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 13px;
            margin-bottom: 4px;
            cursor: pointer;
        }
        
        .workspace-select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 14px;
            color: var(--text-muted);
        }
        
        .nav-item:hover {
            background: var(--surface-hover);
            color: var(--text);
        }
        
        .nav-item.active {
            background: var(--accent);
            color: white;
        }
        
        .nav-item .icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }
        
        .nav-item .count {
            margin-left: auto;
            font-size: 12px;
            color: var(--text-dim);
            background: var(--bg);
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .nav-item.active .count {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .scope-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .scope-dot.me { background: var(--scope-me); }
        .scope-dot.us { background: var(--scope-us); }
        .scope-dot.we { background: var(--scope-we); }
        .scope-dot.there { background: var(--scope-there); }
        
        .folder-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .folder-item:hover {
            background: var(--surface-hover);
            color: var(--text);
        }
        
        .folder-item.active {
            background: var(--surface-hover);
            color: var(--text);
        }
        
        .add-folder {
            color: var(--text-dim);
            font-size: 12px;
        }
        
        .add-folder:hover {
            color: var(--accent);
        }
        
        /* Main Content */
        main {
            background: var(--bg);
            overflow-y: auto;
            padding: 20px;
        }
        
        .content-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .content-title {
            font-size: 24px;
            font-weight: 700;
        }
        
        .view-toggle {
            display: flex;
            gap: 4px;
            background: var(--surface);
            padding: 4px;
            border-radius: 8px;
        }
        
        .view-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .view-btn.active {
            background: var(--surface-hover);
            color: var(--text);
        }
        
        /* Selection Toolbar */
        .selection-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--surface);
            border: 1px solid var(--accent);
            border-radius: 8px;
            margin-bottom: 16px;
            animation: slideDown 0.2s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .selection-info {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text);
            font-weight: 500;
        }
        
        .selection-info input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent);
        }
        
        .selection-actions {
            display: flex;
            gap: 8px;
        }
        
        .selection-actions .action-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s ease;
        }
        
        .selection-actions .action-btn:hover {
            background: var(--surface-hover);
            border-color: var(--accent);
        }
        
        .selection-actions .action-btn.danger {
            border-color: #ef4444;
            color: #ef4444;
        }
        
        .selection-actions .action-btn.danger:hover {
            background: #ef444420;
        }
        
        /* File Checkbox */
        .file-checkbox {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent);
            z-index: 10;
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        
        .file-card:hover .file-checkbox,
        .file-card.multi-selected .file-checkbox,
        .file-row:hover .file-checkbox,
        .file-row.multi-selected .file-checkbox,
        .selection-toolbar:not([style*="display: none"]) ~ #fileContainer .file-checkbox {
            opacity: 1;
        }
        
        .file-checkbox:checked {
            opacity: 1;
        }
        
        .file-card.multi-selected,
        .file-row.multi-selected {
            border-color: var(--accent);
            background: var(--accent-bg, rgba(59, 130, 246, 0.1));
        }
        
        /* Row checkbox positioning */
        .file-row .file-checkbox {
            position: relative;
            top: auto;
            left: auto;
            margin-right: 12px;
            opacity: 1;
        }
        
        /* File Grid */
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        
        .file-card {
            position: relative;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .file-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        
        .file-card:hover .open-btn {
            opacity: 1;
        }
        
        .open-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 6px 12px;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
            z-index: 10;
        }
        
        .open-btn:hover {
            background: var(--accent-hover);
        }
        
        .file-card.selected {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }
        
        .file-card-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .file-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .file-icon.pointer { background: rgba(236, 72, 153, 0.2); }
        .file-icon.slate { background: rgba(99, 102, 241, 0.2); }
        .file-icon.done { background: rgba(59, 130, 246, 0.2); }
        .file-icon.journey { background: rgba(245, 158, 11, 0.2); }
        .file-icon.merman { background: rgba(6, 182, 212, 0.2); }
        .file-icon.metric { background: rgba(16, 185, 129, 0.2); }
        
        .file-info {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-meta {
            font-size: 12px;
            color: var(--text-dim);
        }
        
        .file-scope {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .file-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .tag {
            padding: 4px 10px;
            background: var(--bg);
            border-radius: 12px;
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .file-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        
        .file-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        
        .status-dot.backlog { background: var(--status-backlog); }
        .status-dot.in-progress { background: var(--status-progress); }
        .status-dot.done { background: var(--status-done); }
        .status-dot.closed { background: var(--status-closed); }
        
        .file-date {
            font-size: 12px;
            color: var(--text-dim);
        }
        
        /* File List View */
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .file-row {
            position: relative;
            display: grid;
            grid-template-columns: 40px 1fr 120px 100px 100px 80px 70px;
            gap: 16px;
            align-items: center;
            padding: 12px 16px;
            background: var(--surface);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .file-row:hover {
            background: var(--surface-hover);
        }
        
        .file-row .row-open-btn {
            padding: 6px 12px;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .file-row:hover .row-open-btn {
            opacity: 1;
        }
        
        .file-row .row-open-btn:hover {
            background: var(--accent-hover);
        }
        
        .file-row.selected {
            background: rgba(99, 102, 241, 0.15);
        }
        
        .file-row .file-icon {
            width: 32px;
            height: 32px;
            font-size: 16px;
        }
        
        .file-row .file-name {
            margin-bottom: 0;
        }
        
        /* Details Panel */
        .details-panel {
            background: var(--surface);
            border-left: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
        }
        
        .details-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .details-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
        }
        
        .close-details {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 18px;
        }
        
        .details-icon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin-bottom: 16px;
        }
        
        .details-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .details-type {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }
        
        .details-section {
            margin-bottom: 20px;
        }
        
        .details-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }
        
        .details-value {
            font-size: 14px;
        }
        
        .details-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .details-tags .tag {
            background: var(--bg);
        }
        
        .add-tag-btn {
            padding: 4px 10px;
            background: transparent;
            border: 1px dashed var(--border);
            border-radius: 12px;
            font-size: 11px;
            color: var(--text-dim);
            cursor: pointer;
        }
        
        .add-tag-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .status-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
        }
        
        .scope-select {
            display: flex;
            gap: 8px;
        }
        
        .scope-option {
            flex: 1;
            padding: 10px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .scope-option:hover {
            border-color: var(--text-dim);
        }
        
        .scope-option.active {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }
        
        .scope-option .scope-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .scope-option .scope-label {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .details-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        .details-actions .btn {
            justify-content: center;
        }
        
        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: var(--text-muted);
            text-align: center;
        }
        
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text);
        }
        
        .empty-state p {
            font-size: 14px;
            max-width: 300px;
        }
        
        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
        }
        
        .toast {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 8px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="app" id="app">
        <header>
            <a href="index.html" class="home-btn" title="Back to Work Suite">üß∞</a>
            <div class="logo">
                <span class="logo-icon">üè∑Ô∏è</span>
                <span>Tags</span>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search files, tags, folders...">
            </div>
            <div class="header-actions">
                <button class="btn" onclick="showImportDemo()">
                    <span>üì•</span> Import
                </button>
                <button class="btn btn-primary" onclick="createNewFolder()">
                    <span>‚ûï</span> New Folder
                </button>
            </div>
        </header>
        
        <aside class="sidebar">
            <!-- Workspace Selector (Service-0 Integration) -->
            <div class="sidebar-section" id="workspaceSection" style="display: none;">
                <div class="sidebar-title">
                    Workspace
                    <button class="btn-small" onclick="createWorkspace()" title="Create Workspace">‚ûï</button>
                </div>
                <select id="workspaceSelect" class="workspace-select" onchange="selectWorkspace(this.value)">
                    <option value="">Local Storage</option>
                </select>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Scope</div>
                <div class="nav-item active" data-scope="all" onclick="filterByScope('all')">
                    <span class="icon">üìÅ</span>
                    <span>All Files</span>
                    <span class="count" id="countAll">0</span>
                </div>
                <div class="nav-item" data-scope="me" onclick="filterByScope('me')">
                    <div class="scope-dot me"></div>
                    <span>Me</span>
                    <span class="count" id="countMe">0</span>
                </div>
                <div class="nav-item" data-scope="us" onclick="filterByScope('us')">
                    <div class="scope-dot us"></div>
                    <span>Us</span>
                    <span class="count" id="countUs">0</span>
                </div>
                <div class="nav-item" data-scope="we" onclick="filterByScope('we')">
                    <div class="scope-dot we"></div>
                    <span>We</span>
                    <span class="count" id="countWe">0</span>
                </div>
                <div class="nav-item" data-scope="there" onclick="filterByScope('there')">
                    <div class="scope-dot there"></div>
                    <span>There</span>
                    <span class="count" id="countThere">0</span>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Status</div>
                <div class="nav-item" data-status="backlog" onclick="filterByStatus('backlog')">
                    <span class="icon">üìã</span>
                    <span>Backlog</span>
                </div>
                <div class="nav-item" data-status="in-progress" onclick="filterByStatus('in-progress')">
                    <span class="icon">üîÑ</span>
                    <span>In Progress</span>
                </div>
                <div class="nav-item" data-status="done" onclick="filterByStatus('done')">
                    <span class="icon">‚úÖ</span>
                    <span>Done</span>
                </div>
                <div class="nav-item" data-status="closed" onclick="filterByStatus('closed')">
                    <span class="icon">üì¶</span>
                    <span>Closed</span>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Folders</div>
                <div id="folderList"></div>
                <div class="folder-item add-folder" onclick="createNewFolder()">
                    <span>‚ûï</span>
                    <span>Add Folder</span>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Apps</div>
                <div class="nav-item" data-type="pointer" onclick="filterByType('pointer')">
                    <span class="icon">üëÜ</span>
                    <span>Pointer</span>
                </div>
                <div class="nav-item" data-type="slate" onclick="filterByType('slate')">
                    <span class="icon">üìù</span>
                    <span>Slate</span>
                </div>
                <div class="nav-item" data-type="done" onclick="filterByType('done')">
                    <span class="icon">‚úÖ</span>
                    <span>Done</span>
                </div>
                <div class="nav-item" data-type="journey" onclick="filterByType('journey')">
                    <span class="icon">üõ§Ô∏è</span>
                    <span>Journey</span>
                </div>
                <div class="nav-item" data-type="merman" onclick="filterByType('merman')">
                    <span class="icon">üê†</span>
                    <span>Merman</span>
                </div>
                <div class="nav-item" data-type="metric" onclick="filterByType('metric')">
                    <span class="icon">üìä</span>
                    <span>Metric</span>
                </div>
            </div>
        </aside>
        
        <main>
            <div class="content-header">
                <h1 class="content-title" id="contentTitle">All Files</h1>
                <div class="view-toggle">
                    <button class="view-btn active" onclick="setView('grid')">Grid</button>
                    <button class="view-btn" onclick="setView('list')">List</button>
                </div>
            </div>
            
            <!-- Selection Toolbar -->
            <div id="selectionToolbar" class="selection-toolbar" style="display: none;">
                <div class="selection-info">
                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" />
                    <span id="selectionCount">0 selected</span>
                </div>
                <div class="selection-actions">
                    <button class="action-btn" onclick="bulkChangeStatus('done')">‚úÖ Mark Done</button>
                    <button class="action-btn" onclick="bulkChangeStatus('in-progress')">üîÑ In Progress</button>
                    <button class="action-btn danger" onclick="bulkDelete()">üóëÔ∏è Delete</button>
                    <button class="action-btn" onclick="clearSelection()">‚úï Clear</button>
                </div>
            </div>
            
            <div id="fileContainer" class="file-grid">
                <!-- Files rendered here -->
            </div>
        </main>
        
        <aside class="details-panel" id="detailsPanel">
            <div class="details-header">
                <span class="details-title">Details</span>
                <button class="close-details" onclick="closeDetails()">‚úï</button>
            </div>
            <div id="detailsContent">
                <div class="empty-state">
                    <div class="icon">üìÑ</div>
                    <p>Select a file to view details</p>
                </div>
            </div>
        </aside>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ==================== STATE ====================
        let files = [];
        let folders = ['Projects', 'Personal', 'Archive'];
        let currentFilter = { type: 'all', value: 'all' };
        let currentView = 'grid';
        let selectedFile = null;
        let selectedFiles = new Set(); // Multi-select
        let lastSelectedIndex = -1; // For shift-click range selection
        
        // App type info
        const appTypes = {
            pointer: { icon: 'üëÜ', name: 'Pointer Presentation', color: 'var(--app-pointer)' },
            slate: { icon: 'üìù', name: 'Slate Note', color: 'var(--app-slate)' },
            done: { icon: '‚úÖ', name: 'Done Board', color: 'var(--app-done)' },
            journey: { icon: 'üõ§Ô∏è', name: 'Journey Timeline', color: 'var(--app-journey)' },
            merman: { icon: 'üê†', name: 'Merman Document', color: 'var(--app-merman)' },
            metric: { icon: 'üìä', name: 'Metric Sheet', color: 'var(--app-metric)' }
        };
        
        // ==================== WORKSPACE MANAGEMENT ====================
        let currentUser = null;
        let workspaces = [];
        let currentWorkspace = null;
        
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/session', { credentials: 'include' });
                const data = await response.json();
                if (data.authenticated && data.user) {
                    currentUser = data.user;
                    return true;
                }
            } catch (e) {
                console.log('Auth check failed (offline mode)');
            }
            return false;
        }
        
        async function loadWorkspaces() {
            if (!currentUser) return;
            
            try {
                const response = await fetch('/api/workspaces', { credentials: 'include' });
                workspaces = await response.json();
                
                const select = document.getElementById('workspaceSelect');
                select.innerHTML = '<option value="">Local Storage</option>';
                
                workspaces.forEach(ws => {
                    const option = document.createElement('option');
                    option.value = ws.workspace_id;
                    option.textContent = ws.name;
                    select.appendChild(option);
                });
                
                // Show workspace section
                document.getElementById('workspaceSection').style.display = 'block';
            } catch (e) {
                console.log('Failed to load workspaces:', e);
            }
        }
        
        async function selectWorkspace(workspaceId) {
            currentWorkspace = workspaceId || null;
            
            if (workspaceId) {
                // Load files from API for this workspace
                try {
                    const response = await fetch(`/api/items?workspace_id=${workspaceId}`, { credentials: 'include' });
                    files = await response.json();
                } catch (e) {
                    console.log('Failed to load workspace files:', e);
                    files = [];
                }
            } else {
                // Load from localStorage
                loadFromLocalStorage();
                if (files.length === 0) {
                    loadDemoData();
                }
            }
            
            renderFiles();
            renderFolders();
            updateCounts();
        }
        
        async function createWorkspace() {
            const name = prompt('Enter workspace name:');
            if (!name) return;
            
            try {
                const response = await fetch('/api/workspaces', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        description: 'Created from Tags app',
                        type: 'personal'
                    })
                });
                
                if (response.ok) {
                    const workspace = await response.json();
                    showToast(`Workspace "${name}" created`);
                    await loadWorkspaces();
                    document.getElementById('workspaceSelect').value = workspace.workspace_id;
                    selectWorkspace(workspace.workspace_id);
                } else {
                    showToast('Failed to create workspace', true);
                }
            } catch (e) {
                showToast('Failed to create workspace', true);
            }
        }
        
        // ==================== INITIALIZATION ====================
        async function init() {
            // Check if user is authenticated
            const isAuth = await checkAuth();
            if (isAuth) {
                await loadWorkspaces();
            }
            
            loadFromLocalStorage();
            
            // If no files, load demo data
            if (files.length === 0) {
                loadDemoData();
            } else {
                // Check if demo files need content added (upgrade from old version)
                upgradeDemoFilesWithContent();
            }
            
            renderFiles();
            renderFolders();
            updateCounts();
            
            // Setup search
            document.getElementById('searchInput').addEventListener('input', (e) => {
                filterBySearch(e.target.value);
            });
        }
        
        // Upgrade existing demo files to include content
        function upgradeDemoFilesWithContent() {
            const demoContent = getDemoContent();
            let updated = false;
            
            files.forEach(file => {
                if (file.id && file.id.startsWith('demo-') && !file.content) {
                    const content = demoContent[file.id];
                    if (content) {
                        file.content = content;
                        updated = true;
                    }
                }
            });
            
            if (updated) {
                saveToLocalStorage();
                console.log('Upgraded demo files with content');
            }
        }
        
        function getDemoContent() {
            return {
                'demo-1': `# Q4 Marketing Plan\n\n---\n\n## Goals\n\n- Increase brand awareness by 25%\n- Launch 3 new product campaigns\n- Grow social media following\n\n---\n\n## Timeline\n\n| Month | Focus |\n|-------|-------|\n| October | Campaign prep |\n| November | Launch |\n| December | Review |`,
                'demo-2': `# Meeting Notes\n\n**Date:** November 28, 2024\n**Attendees:** Team leads\n\n## Action Items\n\n- [ ] Review Q4 goals\n- [ ] Update roadmap\n- [x] Schedule follow-up\n\n## Discussion Points\n\nKey decisions made regarding the product launch timeline.`,
                'demo-3': JSON.stringify({
                    columns: ['Backlog', 'In Progress', 'Done'],
                    cards: [
                        { id: 1, column: 'Backlog', title: 'Setup CI/CD' },
                        { id: 2, column: 'In Progress', title: 'API Integration' },
                        { id: 3, column: 'Done', title: 'Database Design' }
                    ]
                }),
                'demo-4': JSON.stringify({
                    events: [
                        { date: '2024-01', title: 'MVP Launch', description: 'Initial release' },
                        { date: '2024-06', title: 'V2 Release', description: 'Major update' },
                        { date: '2024-12', title: 'Enterprise', description: 'Enterprise features' }
                    ]
                }),
                'demo-5': `# API Documentation\n\n## Endpoints\n\n### GET /users\n\nReturns a list of users.\n\n\`\`\`json\n{\n  "users": []\n}\n\`\`\`\n\n## Diagram\n\n\`\`\`mermaid\nsequenceDiagram\n    Client->>API: GET /users\n    API->>DB: Query users\n    DB-->>API: User list\n    API-->>Client: JSON response\n\`\`\``,
                'demo-6': JSON.stringify({
                    headers: ['Category', 'Budget', 'Spent', 'Remaining'],
                    rows: [
                        ['Marketing', 5000, 3200, 1800],
                        ['Development', 10000, 8500, 1500],
                        ['Operations', 3000, 2100, 900]
                    ]
                }),
                'demo-7': `# Team Onboarding\n\n---\n\n## Welcome!\n\nWelcome to the team. This presentation covers everything you need to get started.\n\n---\n\n## First Week\n\n1. Setup your environment\n2. Meet the team\n3. Review documentation\n\n---\n\n## Resources\n\n- Company Wiki\n- Slack channels\n- Team calendar`,
                'demo-8': `# Ideas & Brainstorm\n\n## Product Ideas\n\n- AI-powered search\n- Real-time collaboration\n- Mobile app\n\n## Features to Explore\n\n- Voice notes\n- OCR for images\n- Integration with calendars`
            };
        }
        
        function loadDemoData() {
            files = [
                {
                    id: 'demo-1',
                    name: 'Q4 Marketing Plan',
                    type: 'pointer',
                    folder: 'Projects',
                    tags: ['marketing', 'q4', 'presentation'],
                    status: 'in-progress',
                    scope: 'we',
                    createdAt: Date.now() - 86400000 * 3,
                    updatedAt: Date.now() - 3600000,
                    content: `# Q4 Marketing Plan\n\n---\n\n## Goals\n\n- Increase brand awareness by 25%\n- Launch 3 new product campaigns\n- Grow social media following\n\n---\n\n## Timeline\n\n| Month | Focus |\n|-------|-------|\n| October | Campaign prep |\n| November | Launch |\n| December | Review |`
                },
                {
                    id: 'demo-2',
                    name: 'Meeting Notes - Nov 28',
                    type: 'slate',
                    folder: 'Projects',
                    tags: ['notes', 'meeting'],
                    status: 'done',
                    scope: 'me',
                    createdAt: Date.now() - 86400000,
                    updatedAt: Date.now() - 86400000,
                    content: `# Meeting Notes\n\n**Date:** November 28, 2024\n**Attendees:** Team leads\n\n## Action Items\n\n- [ ] Review Q4 goals\n- [ ] Update roadmap\n- [x] Schedule follow-up\n\n## Discussion Points\n\nKey decisions made regarding the product launch timeline.`
                },
                {
                    id: 'demo-3',
                    name: 'Sprint Board',
                    type: 'done',
                    folder: 'Projects',
                    tags: ['agile', 'sprint', 'tasks'],
                    status: 'in-progress',
                    scope: 'we',
                    createdAt: Date.now() - 86400000 * 7,
                    updatedAt: Date.now() - 1800000,
                    content: JSON.stringify({
                        columns: ['Backlog', 'In Progress', 'Done'],
                        cards: [
                            { id: 1, column: 'Backlog', title: 'Setup CI/CD' },
                            { id: 2, column: 'In Progress', title: 'API Integration' },
                            { id: 3, column: 'Done', title: 'Database Design' }
                        ]
                    })
                },
                {
                    id: 'demo-4',
                    name: 'Product Roadmap 2024',
                    type: 'journey',
                    folder: 'Projects',
                    tags: ['roadmap', 'planning', '2024'],
                    status: 'backlog',
                    scope: 'we',
                    createdAt: Date.now() - 86400000 * 14,
                    updatedAt: Date.now() - 86400000 * 2,
                    content: JSON.stringify({
                        events: [
                            { date: '2024-01', title: 'MVP Launch', description: 'Initial release' },
                            { date: '2024-06', title: 'V2 Release', description: 'Major update' },
                            { date: '2024-12', title: 'Enterprise', description: 'Enterprise features' }
                        ]
                    })
                },
                {
                    id: 'demo-5',
                    name: 'API Documentation',
                    type: 'merman',
                    folder: 'Projects',
                    tags: ['api', 'docs', 'technical'],
                    status: 'done',
                    scope: 'there',
                    createdAt: Date.now() - 86400000 * 5,
                    updatedAt: Date.now() - 86400000,
                    content: `# API Documentation\n\n## Endpoints\n\n### GET /users\n\nReturns a list of users.\n\n\`\`\`json\n{\n  "users": []\n}\n\`\`\`\n\n## Diagram\n\n\`\`\`mermaid\nsequenceDiagram\n    Client->>API: GET /users\n    API->>DB: Query users\n    DB-->>API: User list\n    API-->>Client: JSON response\n\`\`\``
                },
                {
                    id: 'demo-6',
                    name: 'Budget Tracker',
                    type: 'metric',
                    folder: 'Personal',
                    tags: ['budget', 'finance'],
                    status: 'in-progress',
                    scope: 'me',
                    createdAt: Date.now() - 86400000 * 30,
                    updatedAt: Date.now() - 3600000 * 5,
                    content: JSON.stringify({
                        headers: ['Category', 'Budget', 'Spent', 'Remaining'],
                        rows: [
                            ['Marketing', 5000, 3200, 1800],
                            ['Development', 10000, 8500, 1500],
                            ['Operations', 3000, 2100, 900]
                        ]
                    })
                },
                {
                    id: 'demo-7',
                    name: 'Team Onboarding',
                    type: 'pointer',
                    folder: 'Projects',
                    tags: ['onboarding', 'hr', 'training'],
                    status: 'closed',
                    scope: 'us',
                    createdAt: Date.now() - 86400000 * 60,
                    updatedAt: Date.now() - 86400000 * 30,
                    content: `# Team Onboarding\n\n---\n\n## Welcome!\n\nWelcome to the team. This presentation covers everything you need to get started.\n\n---\n\n## First Week\n\n1. Setup your environment\n2. Meet the team\n3. Review documentation\n\n---\n\n## Resources\n\n- Company Wiki\n- Slack channels\n- Team calendar`
                },
                {
                    id: 'demo-8',
                    name: 'Ideas & Brainstorm',
                    type: 'slate',
                    folder: 'Personal',
                    tags: ['ideas', 'brainstorm', 'creative'],
                    status: 'backlog',
                    scope: 'me',
                    createdAt: Date.now() - 86400000 * 2,
                    updatedAt: Date.now() - 86400000,
                    content: `# Ideas & Brainstorm\n\n## Product Ideas\n\n- AI-powered search\n- Real-time collaboration\n- Mobile app\n\n## Features to Explore\n\n- Voice notes\n- OCR for images\n- Integration with calendars`
                }
            ];
            saveToLocalStorage();
        }
        
        // ==================== RENDERING ====================
        function renderFiles() {
            const container = document.getElementById('fileContainer');
            const filteredFiles = getFilteredFiles();
            
            if (filteredFiles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìÇ</div>
                        <h3>No files found</h3>
                        <p>Files you save from Work Suite apps will appear here</p>
                    </div>
                `;
                return;
            }
            
            container.className = currentView === 'grid' ? 'file-grid' : 'file-list';
            
            if (currentView === 'grid') {
                container.innerHTML = filteredFiles.map(file => renderFileCard(file)).join('');
            } else {
                container.innerHTML = filteredFiles.map(file => renderFileRow(file)).join('');
            }
        }
        
        function renderFileCard(file) {
            const app = appTypes[file.type];
            const scopeClass = file.scope;
            const statusClass = file.status.replace('-', '');
            const isMultiSelected = selectedFiles.has(file.id);
            
            return `
                <div class="file-card ${selectedFile?.id === file.id ? 'selected' : ''} ${isMultiSelected ? 'multi-selected' : ''}" 
                     onclick="handleFileClick(event, '${file.id}')" 
                     ondblclick="openFile('${file.id}')">
                    <input type="checkbox" class="file-checkbox" 
                           ${isMultiSelected ? 'checked' : ''} 
                           onclick="event.stopPropagation(); toggleFileSelection('${file.id}')" />
                    <button class="open-btn" onclick="event.stopPropagation(); openFile('${file.id}')">
                        Open ${app.icon}
                    </button>
                    <div class="file-card-header">
                        <div class="file-icon ${file.type}">${app.icon}</div>
                        <div class="file-info">
                            <div class="file-name">${escapeHtml(file.name)}</div>
                            <div class="file-meta">${app.name}</div>
                        </div>
                        <div class="file-scope scope-dot ${scopeClass}" title="${file.scope}"></div>
                    </div>
                    <div class="file-tags">
                        ${file.tags.slice(0, 3).map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                        ${file.tags.length > 3 ? `<span class="tag">+${file.tags.length - 3}</span>` : ''}
                    </div>
                    <div class="file-footer">
                        <div class="file-status">
                            <div class="status-dot ${file.status}"></div>
                            <span>${formatStatus(file.status)}</span>
                        </div>
                        <div class="file-date">${formatDate(file.updatedAt)}</div>
                    </div>
                </div>
            `;
        }
        
        function renderFileRow(file) {
            const app = appTypes[file.type];
            const isMultiSelected = selectedFiles.has(file.id);
            
            return `
                <div class="file-row ${selectedFile?.id === file.id ? 'selected' : ''} ${isMultiSelected ? 'multi-selected' : ''}" 
                     onclick="handleFileClick(event, '${file.id}')"
                     ondblclick="openFile('${file.id}')">
                    <input type="checkbox" class="file-checkbox" 
                           ${isMultiSelected ? 'checked' : ''} 
                           onclick="event.stopPropagation(); toggleFileSelection('${file.id}')" />
                    <div class="file-icon ${file.type}">${app.icon}</div>
                    <div class="file-name">${escapeHtml(file.name)}</div>
                    <div class="file-tags">
                        ${file.tags.slice(0, 2).map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                    </div>
                    <div class="file-status">
                        <div class="status-dot ${file.status}"></div>
                        <span>${formatStatus(file.status)}</span>
                    </div>
                    <div>${file.folder}</div>
                    <div class="file-date">${formatDate(file.updatedAt)}</div>
                    <button class="row-open-btn" onclick="event.stopPropagation(); openFile('${file.id}')">
                        Open
                    </button>
                </div>
            `;
        }
        
        function renderFolders() {
            const container = document.getElementById('folderList');
            container.innerHTML = folders.map(folder => `
                <div class="folder-item" data-folder="${folder}" onclick="filterByFolder('${folder}')">
                    <span>üìÅ</span>
                    <span>${escapeHtml(folder)}</span>
                </div>
            `).join('');
        }
        
        function renderDetails(file) {
            const app = appTypes[file.type];
            const content = document.getElementById('detailsContent');
            
            content.innerHTML = `
                <div class="details-icon ${file.type}">${app.icon}</div>
                <div class="details-name">${escapeHtml(file.name)}</div>
                <div class="details-type">${app.name}</div>
                
                <div class="details-section">
                    <div class="details-label">Folder</div>
                    <div class="details-value">${file.folder}</div>
                </div>
                
                <div class="details-section">
                    <div class="details-label">Tags</div>
                    <div class="details-tags">
                        ${file.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                        <button class="add-tag-btn" onclick="addTagToFile('${file.id}')">+ Add</button>
                    </div>
                </div>
                
                <div class="details-section">
                    <div class="details-label">Status</div>
                    <select class="status-select" onchange="updateFileStatus('${file.id}', this.value)">
                        <option value="backlog" ${file.status === 'backlog' ? 'selected' : ''}>üìã Backlog</option>
                        <option value="in-progress" ${file.status === 'in-progress' ? 'selected' : ''}>üîÑ In Progress</option>
                        <option value="done" ${file.status === 'done' ? 'selected' : ''}>‚úÖ Done</option>
                        <option value="closed" ${file.status === 'closed' ? 'selected' : ''}>üì¶ Closed</option>
                    </select>
                </div>
                
                <div class="details-section">
                    <div class="details-label">Scope</div>
                    <div class="scope-select">
                        <div class="scope-option ${file.scope === 'me' ? 'active' : ''}" onclick="updateFileScope('${file.id}', 'me')">
                            <div class="scope-icon">üë§</div>
                            <div class="scope-label">Me</div>
                        </div>
                        <div class="scope-option ${file.scope === 'us' ? 'active' : ''}" onclick="updateFileScope('${file.id}', 'us')">
                            <div class="scope-icon">üë•</div>
                            <div class="scope-label">Us</div>
                        </div>
                        <div class="scope-option ${file.scope === 'we' ? 'active' : ''}" onclick="updateFileScope('${file.id}', 'we')">
                            <div class="scope-icon">üè¢</div>
                            <div class="scope-label">We</div>
                        </div>
                        <div class="scope-option ${file.scope === 'there' ? 'active' : ''}" onclick="updateFileScope('${file.id}', 'there')">
                            <div class="scope-icon">üåê</div>
                            <div class="scope-label">There</div>
                        </div>
                    </div>
                </div>
                
                <div class="details-section">
                    <div class="details-label">Created</div>
                    <div class="details-value">${new Date(file.createdAt).toLocaleDateString()}</div>
                </div>
                
                <div class="details-section">
                    <div class="details-label">Modified</div>
                    <div class="details-value">${new Date(file.updatedAt).toLocaleString()}</div>
                </div>
                
                <div class="details-actions">
                    <button class="btn btn-primary" onclick="openFile('${file.id}')">
                        <span>üìÇ</span> Open in ${app.name.split(' ')[0]}
                    </button>
                    <button class="btn" onclick="deleteFile('${file.id}')">
                        <span>üóëÔ∏è</span> Delete
                    </button>
                </div>
            `;
        }
        
        // ==================== FILTERING ====================
        function getFilteredFiles() {
            let result = [...files];
            
            switch (currentFilter.type) {
                case 'scope':
                    if (currentFilter.value !== 'all') {
                        result = result.filter(f => f.scope === currentFilter.value);
                    }
                    break;
                case 'status':
                    result = result.filter(f => f.status === currentFilter.value);
                    break;
                case 'folder':
                    result = result.filter(f => f.folder === currentFilter.value);
                    break;
                case 'type':
                    result = result.filter(f => f.type === currentFilter.value);
                    break;
                case 'search':
                    const query = currentFilter.value.toLowerCase();
                    result = result.filter(f => 
                        f.name.toLowerCase().includes(query) ||
                        f.tags.some(t => t.toLowerCase().includes(query)) ||
                        f.folder.toLowerCase().includes(query)
                    );
                    break;
            }
            
            // Sort by updated date
            result.sort((a, b) => b.updatedAt - a.updatedAt);
            
            return result;
        }
        
        function filterByScope(scope) {
            currentFilter = { type: 'scope', value: scope };
            document.getElementById('contentTitle').textContent = 
                scope === 'all' ? 'All Files' : `${scope.charAt(0).toUpperCase() + scope.slice(1)} Files`;
            updateActiveNav('scope', scope);
            renderFiles();
        }
        
        function filterByStatus(status) {
            currentFilter = { type: 'status', value: status };
            document.getElementById('contentTitle').textContent = formatStatus(status);
            updateActiveNav('status', status);
            renderFiles();
        }
        
        function filterByFolder(folder) {
            currentFilter = { type: 'folder', value: folder };
            document.getElementById('contentTitle').textContent = folder;
            updateActiveNav('folder', folder);
            renderFiles();
        }
        
        function filterByType(type) {
            currentFilter = { type: 'type', value: type };
            document.getElementById('contentTitle').textContent = appTypes[type].name + 's';
            updateActiveNav('type', type);
            renderFiles();
        }
        
        function filterBySearch(query) {
            if (query.trim()) {
                currentFilter = { type: 'search', value: query };
                document.getElementById('contentTitle').textContent = `Search: "${query}"`;
            } else {
                currentFilter = { type: 'scope', value: 'all' };
                document.getElementById('contentTitle').textContent = 'All Files';
            }
            renderFiles();
        }
        
        function updateActiveNav(type, value) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (type === 'scope' && item.dataset.scope === value) {
                    item.classList.add('active');
                } else if (type === 'status' && item.dataset.status === value) {
                    item.classList.add('active');
                } else if (type === 'type' && item.dataset.type === value) {
                    item.classList.add('active');
                }
            });
            
            document.querySelectorAll('.folder-item').forEach(item => {
                item.classList.toggle('active', type === 'folder' && item.dataset.folder === value);
            });
        }
        
        // ==================== FILE OPERATIONS ====================
        function selectFile(id) {
            selectedFile = files.find(f => f.id === id);
            renderFiles();
            if (selectedFile) {
                renderDetails(selectedFile);
            }
        }
        
        // ==================== MULTI-SELECT ====================
        function handleFileClick(event, id) {
            const filteredFiles = getFilteredFiles();
            const fileIndex = filteredFiles.findIndex(f => f.id === id);
            
            if (event.shiftKey && lastSelectedIndex >= 0) {
                // Shift+click: Select range
                const start = Math.min(lastSelectedIndex, fileIndex);
                const end = Math.max(lastSelectedIndex, fileIndex);
                
                for (let i = start; i <= end; i++) {
                    selectedFiles.add(filteredFiles[i].id);
                }
                updateSelectionUI();
                renderFiles();
            } else if (event.ctrlKey || event.metaKey) {
                // Ctrl/Cmd+click: Toggle selection
                toggleFileSelection(id);
                lastSelectedIndex = fileIndex;
            } else {
                // Normal click: Select single file (old behavior)
                selectFile(id);
                lastSelectedIndex = fileIndex;
            }
        }
        
        function toggleFileSelection(id) {
            if (selectedFiles.has(id)) {
                selectedFiles.delete(id);
            } else {
                selectedFiles.add(id);
            }
            updateSelectionUI();
            renderFiles();
        }
        
        function toggleSelectAll() {
            const filteredFiles = getFilteredFiles();
            const checkbox = document.getElementById('selectAllCheckbox');
            
            if (checkbox.checked) {
                filteredFiles.forEach(f => selectedFiles.add(f.id));
            } else {
                selectedFiles.clear();
            }
            updateSelectionUI();
            renderFiles();
        }
        
        function clearSelection() {
            selectedFiles.clear();
            lastSelectedIndex = -1;
            updateSelectionUI();
            renderFiles();
        }
        
        function updateSelectionUI() {
            const toolbar = document.getElementById('selectionToolbar');
            const countSpan = document.getElementById('selectionCount');
            const checkbox = document.getElementById('selectAllCheckbox');
            const filteredFiles = getFilteredFiles();
            
            if (selectedFiles.size > 0) {
                toolbar.style.display = 'flex';
                countSpan.textContent = `${selectedFiles.size} selected`;
                checkbox.checked = selectedFiles.size === filteredFiles.length;
                checkbox.indeterminate = selectedFiles.size > 0 && selectedFiles.size < filteredFiles.length;
            } else {
                toolbar.style.display = 'none';
            }
        }
        
        async function bulkDelete() {
            const count = selectedFiles.size;
            if (count === 0) return;
            
            if (!confirm(`Delete ${count} file${count > 1 ? 's' : ''}? This cannot be undone.`)) return;
            
            const idsToDelete = Array.from(selectedFiles);
            let deletedCount = 0;
            let failedCount = 0;
            
            for (const id of idsToDelete) {
                try {
                    // Try to delete from API
                    const response = await fetch(`/api/items/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        deletedCount++;
                    } else {
                        failedCount++;
                    }
                } catch (e) {
                    failedCount++;
                }
                
                // Also remove from local state
                files = files.filter(f => f.id !== id);
            }
            
            // Clear selection and update UI
            selectedFiles.clear();
            selectedFile = null;
            saveToLocalStorage();
            updateSelectionUI();
            renderFiles();
            updateCounts();
            closeDetails();
            
            if (failedCount > 0) {
                showToast(`Deleted ${deletedCount} files (${failedCount} failed)`);
            } else {
                showToast(`Deleted ${deletedCount} file${deletedCount > 1 ? 's' : ''}`);
            }
        }
        
        async function bulkChangeStatus(status) {
            const count = selectedFiles.size;
            if (count === 0) return;
            
            for (const id of selectedFiles) {
                const file = files.find(f => f.id === id);
                if (file) {
                    file.status = status;
                    file.updatedAt = Date.now();
                    
                    // Try to update via API
                    try {
                        await fetch(`/api/items/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status })
                        });
                    } catch (e) {
                        // Continue even if API fails
                    }
                }
            }
            
            saveToLocalStorage();
            renderFiles();
            updateCounts();
            showToast(`Updated ${count} file${count > 1 ? 's' : ''} to ${formatStatus(status)}`);
        }
        
        function openFile(id) {
            const file = files.find(f => f.id === id);
            if (!file) return;
            
            // Map app types to their HTML files
            const appUrls = {
                pointer: 'pointer.html',
                slate: 'slate.html',
                done: 'done.html',
                journey: 'journey.html',
                merman: 'merman.html',
                metric: 'metric.html'
            };
            
            const appUrl = appUrls[file.type];
            if (appUrl) {
                // Open the app with the file ID as a query parameter
                // The app can use this to load the file content
                const url = `${appUrl}?tags_id=${file.id}`;
                window.open(url, '_blank');
                showToast(`Opening ${file.name} in ${appTypes[file.type].name}`);
            } else {
                showToast(`Unknown app type: ${file.type}`);
            }
        }
        
        function updateFileStatus(id, status) {
            const file = files.find(f => f.id === id);
            if (file) {
                file.status = status;
                file.updatedAt = Date.now();
                saveToLocalStorage();
                renderFiles();
                showToast(`Status updated to ${formatStatus(status)}`);
            }
        }
        
        function updateFileScope(id, scope) {
            const file = files.find(f => f.id === id);
            if (file) {
                file.scope = scope;
                file.updatedAt = Date.now();
                saveToLocalStorage();
                renderDetails(file);
                renderFiles();
                updateCounts();
                showToast(`Moved to ${scope}`);
            }
        }
        
        function addTagToFile(id) {
            const tag = prompt('Enter a new tag:');
            if (tag && tag.trim()) {
                const file = files.find(f => f.id === id);
                if (file && !file.tags.includes(tag.trim())) {
                    file.tags.push(tag.trim().toLowerCase());
                    file.updatedAt = Date.now();
                    saveToLocalStorage();
                    renderDetails(file);
                    renderFiles();
                }
            }
        }
        
        function deleteFile(id) {
            if (!confirm('Delete this file?')) return;
            
            files = files.filter(f => f.id !== id);
            selectedFile = null;
            saveToLocalStorage();
            renderFiles();
            updateCounts();
            closeDetails();
            showToast('File deleted');
        }
        
        function createNewFolder() {
            const name = prompt('Enter folder name:');
            if (name && name.trim() && !folders.includes(name.trim())) {
                folders.push(name.trim());
                saveToLocalStorage();
                renderFolders();
                showToast(`Folder "${name}" created`);
            }
        }
        
        // ==================== VIEW ====================
        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase() === view);
            });
            renderFiles();
        }
        
        function closeDetails() {
            selectedFile = null;
            document.getElementById('detailsContent').innerHTML = `
                <div class="empty-state">
                    <div class="icon">üìÑ</div>
                    <p>Select a file to view details</p>
                </div>
            `;
            renderFiles();
        }
        
        // ==================== DEMO ====================
        function showImportDemo() {
            showToast('Import feature coming soon! Files will be importable from Work Suite apps.');
        }
        
        // ==================== COUNTS ====================
        function updateCounts() {
            document.getElementById('countAll').textContent = files.length;
            document.getElementById('countMe').textContent = files.filter(f => f.scope === 'me').length;
            document.getElementById('countUs').textContent = files.filter(f => f.scope === 'us').length;
            document.getElementById('countWe').textContent = files.filter(f => f.scope === 'we').length;
            document.getElementById('countThere').textContent = files.filter(f => f.scope === 'there').length;
        }
        
        // ==================== STORAGE ====================
        function saveToLocalStorage() {
            // Always save to localStorage as backup
            localStorage.setItem('tags-files', JSON.stringify(files));
            localStorage.setItem('tags-folders', JSON.stringify(folders));
        }
        
        // Save file to API (when workspace is selected)
        async function saveFileToAPI(file) {
            if (!currentWorkspace || !currentUser) return;
            
            try {
                const method = file.apiId ? 'PUT' : 'POST';
                const url = file.apiId ? `/api/items/${file.apiId}` : '/api/items';
                
                const response = await fetch(url, {
                    method,
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: file.name,
                        type: file.type,
                        app: file.type,
                        scope: file.scope,
                        folder: file.folder,
                        status: file.status,
                        content: file.content,
                        workspace_id: currentWorkspace,
                        tags: file.tags
                    })
                });
                
                if (response.ok) {
                    const savedFile = await response.json();
                    file.apiId = savedFile.id;
                    return savedFile;
                }
            } catch (e) {
                console.error('Failed to save file to API:', e);
            }
            return null;
        }
        
        function loadFromLocalStorage() {
            try {
                const savedFiles = localStorage.getItem('tags-files');
                const savedFolders = localStorage.getItem('tags-folders');
                
                if (savedFiles) files = JSON.parse(savedFiles);
                if (savedFolders) folders = JSON.parse(savedFolders);
            } catch (e) {
                console.error('Error loading from localStorage:', e);
            }
        }
        
        // ==================== UTILITIES ====================
        function formatStatus(status) {
            return status.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }
        
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;
            
            return date.toLocaleDateString();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showToast(message) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }
        
        // Initialize
        init();
    </script>
</body>
</html>

